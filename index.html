<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>监控查询</title>
<style>
html {
  background-image: url('http://106.54.244.161:8090/i/2024/03/28/6604f7ba92527.jpg');
  background-size: cover;
  background-position: center; 
  background-repeat: no-repeat;
}

body {
  font-family: Arial, sans-serif;
  margin: 0;
  padding: 0;
  height: 100vh;
  color: rgb(114, 253, 0);
  position: relative; /* 添加相对定位 */
}

.input-container {
  margin-bottom: 10px;
}

#inputDialog {
  display: none;
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background-color: #fff;
  padding: 20px;
  border-radius: 5px;
  box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
}

#inputDialog label {
  display: block;
  margin-bottom: 5px;
}

#inputDialog input {
  width: 100%;
  margin-bottom: 10px;
  padding: 5px;
  box-sizing: border-box;
}

#inputDialog button {
  margin-top: 10px;
  padding: 5px 10px;
  background-color: #007bff;
  color: #fff;
  border: none;
  border-radius: 3px;
  cursor: pointer;
}

#inputDialog button:hover {
  background-color: #0056b3;
}

.button-container {
  position: fixed;
  bottom: 20px;
  right: 20px;
}

.button {
  display: block;
  padding: 10px 20px;
  background-color: #007bff;
  color: #fff;
  border: none;
  border-radius: 5px;
  text-decoration: none;
  font-size: 16px;
  cursor: pointer;
}

.button:hover {
  background-color: #0056b3;
}

#second-link {
  display: inline-block; /* 设置为内联块级元素 */
  margin-left: 10px; /* 左边距为10px，调整位置 */
  padding: 10px 20px;
  background-color: #007bff;
  color: #fff;
  border: none;
  border-radius: 5px;
  text-decoration: none;
  font-size: 16px;
  cursor: pointer;
}

#second-link:hover {
  background-color: #0056b3;
}

.delete-button {
  padding: 5px 10px;
  background-color: #ff5555;
  color: #fff;
  border: none;
  border-radius: 3px;
  cursor: pointer;
}

.delete-button:hover {
  background-color: #ff0000;
}
</style>
</head>
<body>
<h1>监控查询</h1>

<form id="query-form">
  <div id="input-container">
    <div class="input-row">
      <label for="门店1">门店1:</label>
      <input type="text" id="门店1" name="门店1">
      <button type="button" class="delete-button" onclick="deleteInput('门店1')">删除</button>
    </div>
  </div>

  <button type="button" onclick="addInput()">增加门店</button>
  <button type="button" onclick="removeInput()">减少门店</button>
  <button type="button" onclick="executeQuery()">导出</button>
  <button type="button" onclick="executeQueryOnly()">查询</button>
  <button type="button" onclick="clearResults()">清除结果</button>
</form>

<div id="results"></div>

<h2>新增监控数据</h2>

<form id="insert-form">
  <label for="newData">数据:</label>
  <input type="text" id="newData" name="newData">
  <button type="button" onclick="insertData()">新增</button>
</form>
<!-- 文件上传 -->
<h3>导入门店名</h3>
<input type="file" id="fileInput" onchange="handleFileChange(event)">

<!-- 右下角按钮 -->
<div class="button-container">
    <button class="button" onclick="checkForUpdates()">检查更新</button>
  <a href="https://github.com/8butubb/electron" target="_blank" id="second-link">github</a>
</div>

<script>
  function checkForUpdates() {
  const { ipcRenderer } = require('electron');
  ipcRenderer.send('check-for-updates');
}

const { ipcRenderer } = require('electron');
ipcRenderer.on('update-available', () => {
  alert('发现新版本，请稍后自动更新。');
});

ipcRenderer.on('update-not-available', () => {
  alert('当前已是最新版本。');
});

let inputCounter = 1;

function addInput() {
  const inputContainer = document.getElementById('input-container');
  const newInput = document.createElement('div');
  inputCounter++;
  newInput.classList.add('input-row');
  newInput.innerHTML = `<label for="门店${inputCounter}">门店 ${inputCounter}:</label>
                        <input type="text" id="门店${inputCounter}" name="门店${inputCounter}">
                        <button type="button" class="delete-button" onclick="deleteInput('门店${inputCounter}')">删除</button>`;
  inputContainer.appendChild(newInput);
}

function removeInput() {
  if (inputCounter > 1) {
    const inputContainer = document.getElementById('input-container');
    inputContainer.removeChild(inputContainer.lastChild);
    inputCounter--;
  }
}

function deleteInput(inputId) {
  const inputElement = document.getElementById(inputId);
  if (inputElement) {
    inputElement.parentElement.remove();
    inputCounter--;
  }
  ensureAtLeastOneInput();
}

function ensureAtLeastOneInput() {
  const inputContainer = document.getElementById('input-container');
  const inputRows = inputContainer.querySelectorAll('.input-row');
  if (inputRows.length === 0) {
    addInput();
  }
}

function handleFileChange(event) {
  const file = event.target.files[0];
  const reader = new FileReader();

  reader.onload = function (e) {
    const fileContent = e.target.result;
    const lines = fileContent.split('\n');
    inputCounter = 0; // 重置计数器
    const inputContainer = document.getElementById('input-container');
    inputContainer.innerHTML = ''; // 清空输入框容器

    lines.forEach(line => {
      inputCounter++;
      const newInput = document.createElement('div');
      newInput.classList.add('input-row');
      newInput.innerHTML = `<label for="门店${inputCounter}">门店 ${inputCounter}:</label>
                            <input type="text" id="门店${inputCounter}" name="门店${inputCounter}" value="${line.trim()}">
                            <button type="button" class="delete-button" onclick="deleteInput('门店${inputCounter}')">删除</button>`;
      inputContainer.appendChild(newInput);
    });
  };

  reader.readAsText(file, 'UTF-8');
}

function executeQuery() {
  const inputs = document.querySelectorAll('input[name^="门店"]');
  const queries = Array.from(inputs).map(input => {
    const name = input.value.trim();
    return `SELECT boby FROM jkwj WHERE ExtractValue(boby, '/Device/@name') like '%${name}%'`;
  });

  ipcRenderer.send('query-mysql', { queries });
}

function executeQueryOnly() {
  const inputs = document.querySelectorAll('input[name^="门店"]');
  const queries = Array.from(inputs).map(input => {
    const name = input.value.trim();
    return `SELECT boby FROM jkwj WHERE ExtractValue(boby, '/Device/@name') like '%${name}%'`;
  });

  ipcRenderer.send('query-mysql-only', { queries });
}

function insertData() {
  const newData = document.getElementById('newData').value.trim();
  ipcRenderer.send('insert-data', { data: newData });
}

function clearResults() {
  document.getElementById('results').innerHTML = '';
}

ipcRenderer.on('query-results', (event, results) => {
  const resultsDiv = document.getElementById('results');
  resultsDiv.innerHTML = '';

  results.forEach((queryResult, index) => {
    const resultDiv = document.createElement('div');
    resultDiv.innerText = `Result ${index + 1}:`;

    queryResult.results.forEach(result => {
      const deviceMatch = result.boby.match(/<Device.*?\/>/);
      if (deviceMatch) {
        const deviceInfo = document.createElement('p');
        deviceInfo.innerText = deviceMatch[0];
        resultDiv.appendChild(deviceInfo);
      }
    });

    resultsDiv.appendChild(resultDiv);
  });
});

ipcRenderer.on('query-error', (event, error) => {
  document.getElementById('results').innerText = `Error: ${error}`;
});

ipcRenderer.on('insert-result', (event, result) => {
  const insertResultDiv = document.getElementById('insert-result');
  insertResultDiv.innerText = result;
});

</script>
</body>
</html>
